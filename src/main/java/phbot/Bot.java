/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package phbot;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Scanner;
import java.util.Set;
import java.util.Map.Entry;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import com.google.api.client.googleapis.javanet.GoogleNetHttpTransport;
import com.google.api.client.http.GenericUrl;
import com.google.api.client.http.HttpContent;
import com.google.api.client.http.HttpHeaders;
import com.google.api.client.http.HttpRequest;
import com.google.api.client.http.HttpRequestFactory;
import com.google.api.client.http.HttpRequestInitializer;
import com.google.api.client.http.HttpResponse;
import com.google.api.client.http.UrlEncodedContent;
import com.google.api.client.http.javanet.NetHttpTransport;
import com.google.api.client.json.JsonFactory;
import com.google.api.client.json.JsonParser;
import com.google.api.client.json.JsonToken;
import com.google.api.client.json.jackson2.JacksonFactory;
import com.google.api.client.util.ArrayMap;
import com.google.api.services.classroom.Classroom;
import com.google.api.services.classroom.model.Course;
import com.google.api.services.classroom.model.CourseWork;
import com.google.api.services.classroom.model.ListCourseWorkResponse;
import com.google.api.services.classroom.model.ListCoursesResponse;
import com.google.api.services.classroom.model.TimeOfDay;
import com.google.auth.http.HttpCredentialsAdapter;
import com.google.auth.oauth2.UserCredentials;

import discord4j.common.util.Snowflake;
import discord4j.core.DiscordClientBuilder;
import discord4j.core.GatewayDiscordClient;
import discord4j.core.event.domain.lifecycle.ReadyEvent;
import discord4j.core.event.domain.message.MessageCreateEvent;
import discord4j.core.object.entity.Message;
import discord4j.core.object.entity.Role;
import discord4j.core.object.entity.User;
import discord4j.core.object.entity.channel.TextChannel;

interface Command {
    void execute(MessageCreateEvent event);
}

public class Bot {
    static final Snowflake GUILD_ID = Snowflake.of("617861584005496859");
    private static final String APPLICATION_NAME = "phbot";
    private static final JsonFactory JSON_FACTORY = JacksonFactory.getDefaultInstance();
    static NetHttpTransport HTTP_TRANSPORT;
    private static Map<String, Command> commands = new HashMap<>();
    private static Map<Snowflake, ChannelInfo> channelMapper;
    static Classroom service;

    private static HttpRequestInitializer getGoogleCredentials(final NetHttpTransport HTTP_TRANSPORT)
            throws IOException {
        UserCredentials credentials = UserCredentials.fromStream(new FileInputStream("oauth_tokens.json"));
        credentials.refreshIfExpired();
        return new HttpCredentialsAdapter(credentials);
    }

    static String readDiscordSecret() {
        BufferedReader fin;
        try {
            fin = new BufferedReader(new FileReader("discord_secret.txt"));
            try {
                String s = fin.readLine();
                fin.close();
                return s;
            } catch (IOException e) {
                System.out.println("Error: IOException while reading Discord secret");
            }
        } catch (FileNotFoundException e) {
            System.out.println("Error: Discord secret file missing");
        }
        return "";
    }

    static HttpResponse sendRequest(HttpRequest request) throws Exception {
        System.out.println("\n========== Request ==========");
        System.out.println(request.getRequestMethod() + " " + request.getUrl().build());

        request.getHeaders().forEach((s, o) -> {
            System.out.printf("%s: %s\n", s, o.toString());
        });
        if (request.getRequestMethod().equals("POST")) {
            System.out.println("\nBody:");
            request.getContent().writeTo(System.out);
            System.out.println();
        }

        HttpResponse response = request.execute();

        System.out.println("\n========== Response ==========");
        System.out.println(response.getStatusCode());
        response.getHeaders().forEach((s, o) -> {
            System.out.printf("%s: %s\n", s, o.toString());
        });

        return request.execute();
    }

    static List<Assignment> getAssignments(ChannelInfo info) throws Exception {
        if (info.getAppType().equals("SL")) {
            HttpRequestFactory factory = HTTP_TRANSPORT.createRequestFactory();

            HttpRequest request = factory.buildGetRequest(new GenericUrl("https://phhs.schoolloop.com/portal/login"));
            HttpResponse response = request.execute();

            String cookies = response.getHeaders().get("set-cookie").toString();
            Matcher idMatcher = Pattern.compile("JSESSIONID=[^;]+").matcher(cookies);
            idMatcher.find();
            String jsi = idMatcher.group();
            String html = response.parseAsString();
            idMatcher = Pattern.compile("form_data_id\" value=\"([^\"]+)").matcher(html);
            idMatcher.find();
            String fdi = idMatcher.group(1);

            BufferedReader r = new BufferedReader(new FileReader("sl_password.txt"));
            Map<String, String> params = new HashMap<>();
            params.put("login_name", r.readLine());
            params.put("password", r.readLine());
            params.put("form_data_id", fdi);
            params.put("event_override", "login");
            r.close();
            HttpContent postData = new UrlEncodedContent(params);

            request = factory.buildPostRequest(
                    new GenericUrl("https://phhs.schoolloop.com/portal/login?etarget=login_form"), postData);
            request.getHeaders().setCookie(jsi).setContentType("application/x-www-form-urlencoded");
            request.setFollowRedirects(false);
            request.setThrowExceptionOnExecuteError(false);
            request.execute();

            String groupId = info.getGroupId();
            String periodId = info.getPeriodId();
            Calendar cal = Calendar.getInstance();
            SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd");
            String startDate = formatter.format(cal.getTime());
            cal.add(Calendar.DATE, 3);
            String endDate = formatter.format(cal.getTime());
            String urlString = String.format(
                    "https://phhs.schoolloop.com/pf4/cal/eventsInRange?group_id=%s&period_id=%s&start_date=%s&end_date=%s",
                    groupId, periodId, startDate, endDate);

            request = factory.buildGetRequest(new GenericUrl(urlString));
            request.getHeaders().setCookie(jsi);
            response = request.execute();

            List<Assignment> assignments = new ArrayList<>();

            JsonParser parser = JSON_FACTORY.createJsonParser(response.getContent());
            parser.parseArray(assignments, Assignment.class);
            assignments.forEach(a -> {
                try {
                    a.build();
                } catch (ParseException e) {
                    // TODO Auto-generated catch block
                    e.printStackTrace();
                }
            });
            return assignments;
        }

        ListCourseWorkResponse courseWorkResponse = service.courses().courseWork().list(info.getGcId()).setPageSize(5)
                .execute();
        List<Assignment> assignments = courseWorkResponse.getCourseWork().stream().filter(w -> {
            var googleDate = w.getDueDate();
            if (googleDate == null)
                return true;
            Calendar dueDate = Calendar.getInstance();
            dueDate.set(googleDate.getYear(), googleDate.getMonth() - 1, googleDate.getDay());
            return dueDate.compareTo(Calendar.getInstance()) > 0;
        }).map(w -> {
            Assignment a = new Assignment();
            a.setTitle(w.getTitle());
            var googleDate = w.getDueDate();
            Calendar dueDate = Calendar.getInstance();
            dueDate.set(googleDate.getYear(), googleDate.getMonth() - 1, googleDate.getDay());
            a.setDueDate(dueDate);
            return a;
        }).collect(Collectors.toList());
        return assignments;
    }

    public static void main(String[] args) throws Exception {
        channelMapper = new HashMap<>();
        JsonParser channelInfoParser = JSON_FACTORY.createJsonParser(new FileInputStream("channels.json"));
        channelInfoParser.nextToken();
        Map<?, ?> temp = channelInfoParser.parse(Map.class);
        channelMapper = temp.entrySet().stream()
                .collect(Collectors.toMap(e -> Snowflake.of(e.getKey().toString()), e -> {
                    ChannelInfo c;
                    try {
                        c = JSON_FACTORY.fromString(JSON_FACTORY.toString(e.getValue()), ChannelInfo.class);
                        c.build();
                        return c;
                    } catch (IOException ex) {
                        return new ChannelInfo();
                    }
                }));

        // Build a new authorized API client service.
        HTTP_TRANSPORT = GoogleNetHttpTransport.newTrustedTransport();
        service = new Classroom.Builder(HTTP_TRANSPORT, JSON_FACTORY, getGoogleCredentials(HTTP_TRANSPORT))
                .setApplicationName(APPLICATION_NAME).build();

        GatewayDiscordClient client = DiscordClientBuilder.create(readDiscordSecret()).build().login().block();

        commands.put("ping", event -> {
            System.out.println(event.getMessage().getGuild().block().getId().asString());
            System.out.println("Pong!");
            event.getMessage().getChannel().flatMap(channel -> channel.createMessage("Pong!")).subscribe();
        });

        commands.put("cw", event -> event.getMessage().getChannel().flatMap(channel -> {
            ChannelInfo info = channelMapper.get(channel.getId());
            if (info.getAppType().equals("NA")) {
                return channel.createMessage("This is not a class channel.");
            }
            List<Assignment> assignments = new ArrayList<>();
            String courseName;
            courseName = info.getCourseName();
            String title = "Upcoming coursework for " + courseName + ":";
            try {
                assignments.addAll(getAssignments(info));
            } catch (Exception e) {
                Assignment a = new Assignment();
                a.setTitle("Error while getting coursework.");
                assignments.add(a);
                System.out.println("Error while getting coursework:");
                System.out.println(e.getMessage());
            }
            Collections.sort(assignments);
            return channel.createMessage(spec -> spec.setEmbed(embed -> {
                embed.setTitle(title);
                // embed.setDescription(messageBuilder.toString());
                SimpleDateFormat formatter = new SimpleDateFormat("MM/dd");
                assignments.forEach(a -> {
                    embed.addField("Due " + formatter.format(a.getDueDate().getTime()) + ":", a.getTitle(), false);
                });
                embed.setColor(client.getRoleById(GUILD_ID, info.getRole()).map(r -> r.getColor()).block());
            }));
        }).subscribe());

        client.getEventDispatcher().on(ReadyEvent.class).subscribe(event -> {
            User self = event.getSelf();
            System.out.println(String.format("Logged in as %s#%s", self.getUsername(), self.getDiscriminator()));
        });

        client.getEventDispatcher().on(MessageCreateEvent.class).subscribe(event -> {
            final String content = event.getMessage().getContent();
            for (final Map.Entry<String, Command> entry : commands.entrySet()) {
                if (content.startsWith('!' + entry.getKey())) {
                    System.out.println(entry.getKey() + " command");
                    entry.getValue().execute(event);
                    break;
                }
            }
        });

        client.onDisconnect().block();

    }
}